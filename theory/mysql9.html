<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL9 | 文档</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="文档描述">
    
    <link rel="preload" href="/shancaolv-blog/assets/css/0.styles.d5c3beac.css" as="style"><link rel="preload" href="/shancaolv-blog/assets/js/app.d9fe4499.js" as="script"><link rel="preload" href="/shancaolv-blog/assets/js/3.c1ecc667.js" as="script"><link rel="preload" href="/shancaolv-blog/assets/js/1.6b777cdb.js" as="script"><link rel="preload" href="/shancaolv-blog/assets/js/9.ac47dbea.js" as="script"><link rel="prefetch" href="/shancaolv-blog/assets/js/10.298b8386.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/11.17c2e540.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/12.39fb974a.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/13.bcc90e37.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/14.705de672.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/15.ce73470a.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/16.fc495b40.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/17.535d96f3.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/18.e9b52426.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/19.72634062.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/20.291a1839.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/21.0fd7b4e2.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/22.6c559402.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/23.f81cb988.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/24.3839ee9d.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/25.f8181c87.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/26.9ac6bc28.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/27.2c63fb0f.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/28.1142203c.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/29.776c309d.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/4.2d0ab2d6.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/5.47a3ebbb.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/6.0ff53a76.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/7.d18fb729.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/8.07ec004d.js">
    <link rel="stylesheet" href="/shancaolv-blog/assets/css/0.styles.d5c3beac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>文档</h3> <p class="description" data-v-59e6cb88>文档描述</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/shancaolv-blog/" class="home-link router-link-active"><!----> <span class="site-name">文档</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/shancaolv-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      shanCaoLv 的工作博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/duhn" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>16</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/shancaolv-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      shanCaoLv 的工作博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/duhn" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/shancaolv-blog/" class="sidebar-heading clickable router-link-active open"><span>欢迎学习</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/shancaolv-blog/" aria-current="page" class="sidebar-link">学前必读</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/shancaolv-blog/theory/plan" class="sidebar-heading clickable"><span>理论学习</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/shancaolv-blog/theory/plan.html" class="sidebar-link">计划 </a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/shancaolv-blog/theory/dataStructure/array" class="sidebar-heading clickable"><span>数据结构 </span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/shancaolv-blog/theory/dataStructure/array.html" class="sidebar-link">数组 </a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/shancaolv-blog/theory/mysql0" class="sidebar-heading clickable open"><span>MySQL </span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/shancaolv-blog/theory/mysql0.html" class="sidebar-link">mysql0 </a></li><li><a href="/shancaolv-blog/theory/mysql1.html" class="sidebar-link">mysql1 </a></li><li><a href="/shancaolv-blog/theory/mysql2.html" class="sidebar-link">mysql2 </a></li><li><a href="/shancaolv-blog/theory/mysql3.html" class="sidebar-link">mysql3 </a></li><li><a href="/shancaolv-blog/theory/mysql4.html" class="sidebar-link">mysql4 </a></li><li><a href="/shancaolv-blog/theory/mysql5.html" class="sidebar-link">mysql5 </a></li><li><a href="/shancaolv-blog/theory/mysql6.html" class="sidebar-link">mysql6 </a></li><li><a href="/shancaolv-blog/theory/mysql7.html" class="sidebar-link">mysql7 </a></li><li><a href="/shancaolv-blog/theory/mysql8.html" class="sidebar-link">mysql8 </a></li><li><a href="/shancaolv-blog/theory/mysql9.html" aria-current="page" class="active sidebar-link">mysql9 </a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/shancaolv-blog/practice/plan" class="sidebar-heading clickable"><span>代码实现</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/shancaolv-blog/practice/plan.html" class="sidebar-link">计划 </a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/shancaolv-blog/practice/dataStructure/array" class="sidebar-heading clickable"><span>数据结构 </span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/shancaolv-blog/practice/dataStructure/array.html" class="sidebar-link">数组 </a></li></ul></section></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>MySQL9</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page" style="padding-right:0;"><section style="display:;"><div class="page-title"><h1 class="title">MySQL9</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>shanCaoLv</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2023/5/24</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h3 id="关键词"><a href="#关键词" class="header-anchor">#</a> 关键词</h3> <h1 id="_09-普通索引和唯一索引-应该怎么选择"><a href="#_09-普通索引和唯一索引-应该怎么选择" class="header-anchor">#</a> 09_普通索引和唯一索引，应该怎么选择？</h1> <p>在前面的基础篇文章中，我给你介绍过索引的基本概念，相信你已经了解了唯一索引和普通索引的区别。今天我们就继续来谈谈，在不同的业务场景下，应该选择普通索引，还是唯一索引？</p> <p>假设你在维护一个市民系统，每个人都有一个唯一的身份证号，而且业务代码已经保证了不会写入两个重复的身份证号。如果市民系统需要按照身份证号查姓名，就会执行类似这样的 <strong>SQL</strong> 语句：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">select</span> name <span class="token keyword">from</span> CUser <span class="token keyword">where</span> <span class="token class-name">id_card</span> <span class="token operator">=</span> 'xxxxxxxyyyyyyzzzzz'<span class="token punctuation">;</span>
</code></pre></div><p>所以，你一定会考虑在 <strong>id_card</strong> 字段上建索引。</p> <p>由于身份证号字段比较大，我不建议你把身份证号当做主键，那么现在你有两个选择，要么给 <strong>id_card</strong> 字段创建唯一索引，要么创建一个普通索引。如果业务代码已经保证了不会写入重复的身份证号，那么这两个选择逻辑上都是正确的。</p> <p>现在我要问你的是，从性能的角度考虑，你选择唯一索引还是普通索引呢？选择的依据是什么呢？</p> <p>简单起见，我们还是用第 <strong>4</strong> 篇文章 [<strong>深入浅出索引（上）</strong>]中的例子来说明，假设字段 <strong>k</strong> 上的值都不重复。</p> <p><img src="/shancaolv-blog/assets/img/1ed9536031d6698570ea175a7b7f9a46.14e3a99c.png" alt="img"></p> <p>图 1 InnoDB 的索引组织结构</p> <p>接下来，我们就从这两种索引对查询语句和更新语句的性能影响来进行分析。</p> <h2 id="查询过程"><a href="#查询过程" class="header-anchor">#</a> 查询过程</h2> <p>假设，执行查询的语句是 select id from T where k=5。这个查询语句在索引树上查找的过程，先是通过 B+ 树从树根开始，按层搜索到叶子节点，也就是图中右下角的这个数据页，然后可以认为数据页内部通过二分法来定位记录。</p> <ul><li>对于普通索引来说，查找到满足条件的第一个记录 (5,500) 后，需要查找下一个记录，直到碰到第一个不满足 k=5 条件的记录。</li> <li>对于唯一索引来说，由于索引定义了唯一性，查找到第一个满足条件的记录后，就会停止继续检索。</li></ul> <p>那么，这个不同带来的性能差距会有多少呢？答案是，微乎其微。</p> <p>你知道的，InnoDB 的数据是按数据页为单位来读写的。也就是说，当需要读一条记录的时候，并不是将这个记录本身从磁盘读出来，而是以页为单位，将其整体读入内存。在 InnoDB 中，每个数据页的大小默认是 16KB。</p> <p>因为引擎是按页读写的，所以说，当找到 k=5 的记录的时候，它所在的数据页就都在内存里了。那么，对于普通索引来说，要多做的那一次“查找和判断下一条记录”的操作，就只需要一次指针寻找和一次计算。</p> <p>当然，如果 k=5 这个记录刚好是这个数据页的最后一个记录，那么要取下一个记录，必须读取下一个数据页，这个操作会稍微复杂一些。</p> <p>但是，我们之前计算过，对于整型字段，一个数据页可以放近千个 key，因此出现这种情况的概率会很低。所以，我们计算平均性能差异时，仍可以认为这个操作成本对于现在的 CPU 来说可以忽略不计。</p> <h2 id="更新过程"><a href="#更新过程" class="header-anchor">#</a> 更新过程</h2> <p>为了说明普通索引和唯一索引对更新语句性能的影响这个问题，我需要先跟你介绍一下 change buffer。</p> <p>当需要更新一个数据页时，如果数据页在内存中就直接更新，而如果这个数据页还没有在内存中的话，在不影响数据一致性的前提下，InooDB 会将这些更新操作缓存在 change buffer 中，这样就不需要从磁盘中读入这个数据页了。在下次查询需要访问这个数据页的时候，将数据页读入内存，然后执行 change buffer 中与这个页有关的操作。通过这种方式就能保证这个数据逻辑的正确性。</p> <p>需要说明的是，虽然名字叫作 change buffer，实际上它是可以持久化的数据。也就是说，change buffer 在内存中有拷贝，也会被写入到磁盘上。</p> <p>将 change buffer 中的操作应用到原数据页，得到最新结果的过程称为 merge。除了访问这个数据页会触发 merge 外，系统有后台线程会定期 merge。在数据库正常关闭（shutdown）的过程中，也会执行 merge 操作。</p> <p>显然，如果能够将更新操作先记录在 change buffer，减少读磁盘，语句的执行速度会得到明显的提升。而且，数据读入内存是需要占用 buffer pool 的，所以这种方式还能够避免占用内存，提高内存利用率。</p> <p>那么，<strong>什么条件下可以使用 change buffer 呢？</strong></p> <p>对于唯一索引来说，所有的更新操作都要先判断这个操作是否违反唯一性约束。比如，要插入 (4,400) 这个记录，就要先判断现在表中是否已经存在 k=4 的记录，而这必须要将数据页读入内存才能判断。如果都已经读入到内存了，那直接更新内存会更快，就没必要使用 change buffer 了。</p> <p>因此，唯一索引的更新就不能使用 change buffer，实际上也只有普通索引可以使用。</p> <p>change buffer 用的是 buffer pool 里的内存，因此不能无限增大。change buffer 的大小，可以通过参数 innodb_change_buffer_max_size 来动态设置。这个参数设置为 50 的时候，表示 change buffer 的大小最多只能占用 buffer pool 的 50%。</p> <p>现在，你已经理解了 change buffer 的机制，那么我们再一起来看看<strong>如果要在这张表中插入一个新记录 (4,400) 的话，InnoDB 的处理流程是怎样的。</strong></p> <p>第一种情况是，<strong>这个记录要更新的目标页在内存中</strong>。这时，InnoDB 的处理流程如下：</p> <ul><li>对于唯一索引来说，找到 3 和 5 之间的位置，判断到没有冲突，插入这个值，语句执行结束；</li> <li>对于普通索引来说，找到 3 和 5 之间的位置，插入这个值，语句执行结束。</li></ul> <p>这样看来，普通索引和唯一索引对更新语句性能影响的差别，只是一个判断，只会耗费微小的 CPU 时间。</p> <p>但，这不是我们关注的重点。</p> <p>第二种情况是，<strong>这个记录要更新的目标页不在内存中</strong>。这时，InnoDB 的处理流程如下：</p> <ul><li>对于唯一索引来说，需要将数据页读入内存，判断到没有冲突，插入这个值，语句执行结束；</li> <li>对于普通索引来说，则是将更新记录在 change buffer，语句执行就结束了。</li></ul> <p>将数据从磁盘读入内存涉及随机 IO 的访问，是数据库里面成本最高的操作之一。change buffer 因为减少了随机磁盘访问，所以对更新性能的提升是会很明显的。</p> <p>之前我就碰到过一件事儿，有个 DBA 的同学跟我反馈说，他负责的某个业务的库内存命中率突然从 99% 降低到了 75%，整个系统处于阻塞状态，更新语句全部堵住。而探究其原因后，我发现这个业务有大量插入数据的操作，而他在前一天把其中的某个普通索引改成了唯一索引。</p> <h2 id="change-buffer-的使用场景"><a href="#change-buffer-的使用场景" class="header-anchor">#</a> change buffer 的使用场景</h2> <p>通过上面的分析，你已经清楚了使用 change buffer 对更新过程的加速作用，也清楚了 change buffer 只限于用在普通索引的场景下，而不适用于唯一索引。那么，现在有一个问题就是：普通索引的所有场景，使用 change buffer 都可以起到加速作用吗？</p> <p>因为 merge 的时候是真正进行数据更新的时刻，而 change buffer 的主要目的就是将记录的变更动作缓存下来，所以在一个数据页做 merge 之前，change buffer 记录的变更越多（也就是这个页面上要更新的次数越多），收益就越大。</p> <p>因此，对于写多读少的业务来说，页面在写完以后马上被访问到的概率比较小，此时 change buffer 的使用效果最好。这种业务模型常见的就是账单类、日志类的系统。</p> <p>反过来，假设一个业务的更新模式是写入之后马上会做查询，那么即使满足了条件，将更新先记录在 change buffer，但之后由于马上要访问这个数据页，会立即触发 merge 过程。这样随机访问 IO 的次数不会减少，反而增加了 change buffer 的维护代价。所以，对于这种业务模式来说，change buffer 反而起到了副作用。</p> <h2 id="索引选择和实践"><a href="#索引选择和实践" class="header-anchor">#</a> 索引选择和实践</h2> <p>回到我们文章开头的问题，普通索引和唯一索引应该怎么选择。其实，这两类索引在查询能力上是没差别的，主要考虑的是对更新性能的影响。所以，我建议你尽量选择普通索引。</p> <p>如果所有的更新后面，都马上伴随着对这个记录的查询，那么你应该关闭 change buffer。而在其他情况下，change buffer 都能提升更新性能。</p> <p>在实际使用中，你会发现，普通索引和 change buffer 的配合使用，对于数据量大的表的更新优化还是很明显的。</p> <p>特别地，在使用机械硬盘时，change buffer 这个机制的收效是非常显著的。所以，当你有一个类似“历史数据”的库，并且出于成本考虑用的是机械硬盘时，那你应该特别关注这些表里的索引，尽量使用普通索引，然后把 change buffer 尽量开大，以确保这个“历史数据”表的数据写入速度。</p> <h2 id="change-buffer-和-redo-log"><a href="#change-buffer-和-redo-log" class="header-anchor">#</a> change buffer 和 redo log</h2> <p>理解了 change buffer 的原理，你可能会联想到我在前面文章中和你介绍过的 redo log 和 WAL。</p> <p>在前面文章的评论中，我发现有同学混淆了 redo log 和 change buffer。WAL 提升性能的核心机制，也的确是尽量减少随机读写，这两个概念确实容易混淆。所以，这里我把它们放到了同一个流程里来说明，便于你区分这两个概念。</p> <blockquote><p>备注：这里，你可以再回顾下第 2 篇文章[日志系统：一条 SQL 更新语句是如何执行的？]中的相关内容。</p></blockquote> <p>现在，我们要在表上执行这个插入语句：</p> <div class="language-scss extra-class"><pre class="language-scss"><code>mysql&gt; insert into <span class="token function">t</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span>id1<span class="token punctuation">,</span>k1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>id2<span class="token punctuation">,</span>k2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里，我们假设当前 k 索引树的状态，查找到位置后，k1 所在的数据页在内存 (InnoDB buffer pool) 中，k2 所在的数据页不在内存中。如图 2 所示是带 change buffer 的更新状态图。</p> <p><img src="/shancaolv-blog/assets/img/980a2b786f0ea7adabef2e64fb4c4ca3.e5f6e24f.png" alt="img"></p> <p>图 2 带 change buffer 的更新过程</p> <p>分析这条更新语句，你会发现它涉及了四个部分：内存、redo log（ib_log_fileX）、 数据表空间（t.ibd）、系统表空间（ibdata1）。</p> <p>这条更新语句做了如下的操作（按照图中的数字顺序）：</p> <ol><li>Page 1 在内存中，直接更新内存；</li> <li>Page 2 没有在内存中，就在内存的 change buffer 区域，记录下“我要往 Page 2 插入一行”这个信息</li> <li>将上述两个动作记入 redo log 中（图中 3 和 4）。</li></ol> <p>做完上面这些，事务就可以完成了。所以，你会看到，执行这条更新语句的成本很低，就是写了两处内存，然后写了一处磁盘（两次操作合在一起写了一次磁盘），而且还是顺序写的。</p> <p>同时，图中的两个虚线箭头，是后台操作，不影响更新的响应时间。</p> <p>那在这之后的读请求，要怎么处理呢？</p> <p>比如，我们现在要执行 select * from t where k in (k1, k2)。这里，我画了这两个读请求的流程图。</p> <p>如果读语句发生在更新语句后不久，内存中的数据都还在，那么此时的这两个读操作就与系统表空间（ibdata1）和 redo log（ib_log_fileX）无关了。所以，我在图中就没画出这两部分。</p> <p><img src="/shancaolv-blog/assets/img/6dc743577af1dbcbb8550bddbfc5f98e.e9f28cb2.png" alt="img"></p> <p>图 3 带 change buffer 的读过程</p> <p>从图中可以看到：</p> <ol><li>读 Page 1 的时候，直接从内存返回。有几位同学在前面文章的评论中问到，WAL 之后如果读数据，是不是一定要读盘，是不是一定要从 redo log 里面把数据更新以后才可以返回？其实是不用的。你可以看一下图 3 的这个状态，虽然磁盘上还是之前的数据，但是这里直接从内存返回结果，结果是正确的。</li> <li>要读 Page 2 的时候，需要把 Page 2 从磁盘读入内存中，然后应用 change buffer 里面的操作日志，生成一个正确的版本并返回结果。</li></ol> <p>可以看到，直到需要读 Page 2 的时候，这个数据页才会被读入内存。</p> <p>所以，如果要简单地对比这两个机制在提升更新性能上的收益的话，<strong>redo log 主要节省的是随机写磁盘的 IO 消耗（转成顺序写），而 change buffer 主要节省的则是随机读磁盘的 IO 消耗。</strong></p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>今天，我从普通索引和唯一索引的选择开始，和你分享了数据的查询和更新过程，然后说明了 change buffer 的机制以及应用场景，最后讲到了索引选择的实践。</p> <p>由于唯一索引用不上 change buffer 的优化机制，因此如果业务可以接受，从性能角度出发我建议你优先考虑非唯一索引。</p> <p>最后，又到了思考题时间。</p> <p>通过图 2 你可以看到，change buffer 一开始是写内存的，那么如果这个时候机器掉电重启，会不会导致 change buffer 丢失呢？change buffer 丢失可不是小事儿，再从磁盘读入数据可就没有了 merge 过程，就等于是数据丢失了。会不会出现这种情况呢？</p> <p>你可以把你的思考和观点写在留言区里，我会在下一篇文章的末尾和你讨论这个问题。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p> <p><strong>补充：</strong> 评论区大家对“是否使用唯一索引”有比较多的讨论，主要是纠结在“业务可能无法确保”的情况。这里，我再说明一下：</p> <ul><li>首先，业务正确性优先。咱们这篇文章的前提是“业务代码已经保证不会写入重复数据”的情况下，讨论性能问题。如果业务不能保证，或者业务就是要求数据库来做约束，那么没得选，必须创建唯一索引。这种情况下，本篇文章的意义在于，如果碰上了大量插入数据慢、内存命中率低的时候，可以给你多提供一个排查思路。</li> <li>然后，在一些“归档库”的场景，你是可以考虑使用普通索引的。比如，线上数据只需要保留半年，然后历史数据保存在归档库。这时候，归档数据已经是确保没有唯一键冲突了。要提高归档效率，可以考虑把表里面的唯一索引改成普通索引。</li></ul> <h2 id="上期问题时间"><a href="#上期问题时间" class="header-anchor">#</a> 上期问题时间</h2> <p>上期的问题是：如何构造一个“数据无法修改”的场景。评论区里已经有不少同学给出了正确答案，这里我再描述一下。</p> <p><img src="data:image/png;base64,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" alt="img">这样，session A 看到的就是我截图的效果了。</p> <p>其实，还有另外一种场景，同学们在留言区都还没有提到。</p> <p><img src="/shancaolv-blog/assets/img/e24a0689571337959138d787c408defa.19e34ece.png" alt="img"></p> <p>这个操作序列跑出来，session A 看的内容也是能够复现我截图的效果的。这个 session B’启动的事务比 A 要早，其实是上期我们描述事务版本的可见性规则时留的彩蛋，因为规则里还有一个“活跃事务的判断”，我是准备留到这里再补充的。</p> <p>当我试图在这里讲述完整规则的时候，发现第 8 篇文章[事务到底是隔离的还是不隔离的？]中的解释引入了太多的概念，以致于分析起来非常复杂。</p> <p>因此，我重写了第 8 篇，这样我们人工去判断可见性的时候，才会更方便。【看到这里，我建议你能够再重新打开第 8 篇文章并认真学习一次。如果学习的过程中，有任何问题，也欢迎你给我留言】</p> <p>用新的方式来分析 session B’的更新为什么对 session A 不可见就是：在 session A 视图数组创建的瞬间，session B’是活跃的，属于“版本未提交，不可见”这种情况。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/shancaolv-blog/theory/mysql8.html" class="prev">
          mysql8 
        </a></span> <span class="next"><a href="/shancaolv-blog/practice/plan.html">
          计划 
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:0;" data-v-b57cc07c data-v-7dd95ae2></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/shancaolv-blog/assets/js/app.d9fe4499.js" defer></script><script src="/shancaolv-blog/assets/js/3.c1ecc667.js" defer></script><script src="/shancaolv-blog/assets/js/1.6b777cdb.js" defer></script><script src="/shancaolv-blog/assets/js/9.ac47dbea.js" defer></script>
  </body>
</html>
