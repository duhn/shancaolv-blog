<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL5 | 文档</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="文档描述">
    
    <link rel="preload" href="/shancaolv-blog/assets/css/0.styles.d5c3beac.css" as="style"><link rel="preload" href="/shancaolv-blog/assets/js/app.d9fe4499.js" as="script"><link rel="preload" href="/shancaolv-blog/assets/js/3.c1ecc667.js" as="script"><link rel="preload" href="/shancaolv-blog/assets/js/1.6b777cdb.js" as="script"><link rel="preload" href="/shancaolv-blog/assets/js/12.39fb974a.js" as="script"><link rel="prefetch" href="/shancaolv-blog/assets/js/10.298b8386.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/11.17c2e540.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/13.bcc90e37.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/14.705de672.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/15.ce73470a.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/16.fc495b40.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/17.535d96f3.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/18.e9b52426.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/19.72634062.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/20.291a1839.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/21.0fd7b4e2.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/22.6c559402.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/23.f81cb988.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/24.3839ee9d.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/25.f8181c87.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/26.9ac6bc28.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/27.2c63fb0f.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/28.1142203c.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/29.776c309d.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/4.2d0ab2d6.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/5.47a3ebbb.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/6.0ff53a76.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/7.d18fb729.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/8.07ec004d.js"><link rel="prefetch" href="/shancaolv-blog/assets/js/9.ac47dbea.js">
    <link rel="stylesheet" href="/shancaolv-blog/assets/css/0.styles.d5c3beac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>文档</h3> <p class="description" data-v-59e6cb88>文档描述</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/shancaolv-blog/" class="home-link router-link-active"><!----> <span class="site-name">文档</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/shancaolv-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      shanCaoLv 的工作博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/duhn" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>16</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/shancaolv-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      shanCaoLv 的工作博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/duhn" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/shancaolv-blog/" class="sidebar-heading clickable router-link-active open"><span>欢迎学习</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/shancaolv-blog/" aria-current="page" class="sidebar-link">学前必读</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/shancaolv-blog/theory/plan" class="sidebar-heading clickable"><span>理论学习</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/shancaolv-blog/theory/plan.html" class="sidebar-link">计划 </a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/shancaolv-blog/theory/dataStructure/array" class="sidebar-heading clickable"><span>数据结构 </span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/shancaolv-blog/theory/dataStructure/array.html" class="sidebar-link">数组 </a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/shancaolv-blog/theory/mysql0" class="sidebar-heading clickable open"><span>MySQL </span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/shancaolv-blog/theory/mysql0.html" class="sidebar-link">mysql0 </a></li><li><a href="/shancaolv-blog/theory/mysql1.html" class="sidebar-link">mysql1 </a></li><li><a href="/shancaolv-blog/theory/mysql2.html" class="sidebar-link">mysql2 </a></li><li><a href="/shancaolv-blog/theory/mysql3.html" class="sidebar-link">mysql3 </a></li><li><a href="/shancaolv-blog/theory/mysql4.html" class="sidebar-link">mysql4 </a></li><li><a href="/shancaolv-blog/theory/mysql5.html" aria-current="page" class="active sidebar-link">mysql5 </a></li><li><a href="/shancaolv-blog/theory/mysql6.html" class="sidebar-link">mysql6 </a></li><li><a href="/shancaolv-blog/theory/mysql7.html" class="sidebar-link">mysql7 </a></li><li><a href="/shancaolv-blog/theory/mysql8.html" class="sidebar-link">mysql8 </a></li><li><a href="/shancaolv-blog/theory/mysql9.html" class="sidebar-link">mysql9 </a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/shancaolv-blog/practice/plan" class="sidebar-heading clickable"><span>代码实现</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/shancaolv-blog/practice/plan.html" class="sidebar-link">计划 </a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/shancaolv-blog/practice/dataStructure/array" class="sidebar-heading clickable"><span>数据结构 </span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/shancaolv-blog/practice/dataStructure/array.html" class="sidebar-link">数组 </a></li></ul></section></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>MySQL5</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page" style="padding-right:0;"><section style="display:;"><div class="page-title"><h1 class="title">MySQL5</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>shanCaoLv</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2023/5/25</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h3 id="关键词"><a href="#关键词" class="header-anchor">#</a> 关键词</h3> <p>由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段</p> <p>最左前缀原则  B+ 树这种索引结构，可以利用索引的“最左前缀”，来定位记录</p> <p>索引下推</p> <p>alter table T engine=InnoDB</p> <h1 id="_05-深入浅出索引-下"><a href="#_05-深入浅出索引-下" class="header-anchor">#</a> 05_深入浅出索引（下）</h1> <p>在上一篇文章中，我和你介绍了 <strong>InnoDB</strong> 索引的数据结构模型，今天我们再继续聊聊跟 <strong>MySQL</strong> 索引有关的概念。</p> <p>在开始这篇文章之前，我们先来看一下这个问题：</p> <p>在下面这个表 T 中，如果我执行 <strong>select * from T where k between 3 and 5</strong>，需要执行几次树的搜索操作，会扫描多少行？</p> <p>下面是这个表的初始化语句。</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">table</span> T <span class="token punctuation">(</span>
ID <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
k <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span> 
s <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>
<span class="token keyword">index</span> k<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>
 
<span class="token keyword">insert</span> <span class="token keyword">into</span> T <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'aa'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'bb'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'cc'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'ee'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">'ff'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">700</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">'gg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/shancaolv-blog/assets/img/dcda101051f28502bd5c4402b292e38d.8a50f237.png" alt="img"></p> <p>图 1 <strong>InnoDB</strong> 的索引组织结构</p> <p>现在，我们一起来看看这条 <strong>SQL</strong> 查询语句的执行流程：</p> <ol><li>在 <strong>k</strong> 索引树上找到 <strong>k=3</strong> 的记录，取得 <strong>ID = 300</strong>；</li> <li>再到 <strong>ID</strong> 索引树查到 <strong>ID=300</strong> 对应的 <strong>R3</strong>；</li> <li>在 <strong>k</strong> 索引树取下一个值 <strong>k=5</strong>，取得 <strong>ID=500</strong>；</li> <li>再回到 <strong>ID</strong> 索引树查到 <strong>ID=500</strong> 对应的 <strong>R4</strong>；</li> <li>在 <strong>k</strong> 索引树取下一个值 <strong>k=6</strong>，不满足条件，循环结束。</li></ol> <p>在这个过程中，<strong>回到主键索引树搜索的过程，我们称为回表</strong>。可以看到，这个查询过程读了 k 索引树的 3 条记录（步骤 1、3 和 5），回表了两次（步骤 2 和 4）。</p> <p>在这个例子中，由于查询结果所需要的数据只在主键索引上有，所以不得不回表。那么，有没有可能经过索引优化，避免回表过程呢？</p> <h2 id="覆盖索引"><a href="#覆盖索引" class="header-anchor">#</a> 覆盖索引</h2> <p>如果执行的语句是 <strong>select ID from T where k between 3 and 5</strong>，这时只需要查 <strong>ID</strong> 的值，而 <strong>ID</strong> 的值已经在 <strong>k</strong> 索引树上了，因此可以直接提供查询结果，不需要回表。也就是说，在这个查询里面，索引 <strong>k</strong> 已经“覆盖了”我们的查询需求，我们称为覆盖索引。</p> <p><strong>由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段。</strong></p> <p>需要注意的是，在引擎内部使用覆盖索引在索引 <strong>k</strong> 上其实读了三个记录，<strong>R3~R5</strong>（对应的索引 k 上的记录项），但是对于 <strong>MySQL</strong> 的 <strong>Server</strong> 层来说，它就是找引擎拿到了两条记录，因此 MySQL 认为扫描行数是 2。</p> <blockquote><p>备注：关于如何查看扫描行数的问题，我将会在第 16 文章《如何正确地显示随机消息？》中，和你详细讨论。</p></blockquote> <p>基于上面覆盖索引的说明，我们来讨论一个问题：<strong>在一个市民信息表上，是否有必要将身份证号和名字建立联合索引？</strong></p> <p>假设这个市民表的定义是这样的：</p> <div class="language-r extra-class"><pre class="language-r"><code>CREATE TABLE `tuser` <span class="token punctuation">(</span>
  `id` int<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> NOT <span class="token keyword">NULL</span><span class="token punctuation">,</span>
  `id_card` varchar<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> DEFAULT <span class="token keyword">NULL</span><span class="token punctuation">,</span>
  `name` varchar<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> DEFAULT <span class="token keyword">NULL</span><span class="token punctuation">,</span>
  `age` int<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> DEFAULT <span class="token keyword">NULL</span><span class="token punctuation">,</span>
  `ismale` tinyint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> DEFAULT <span class="token keyword">NULL</span><span class="token punctuation">,</span>
  PRIMARY KEY <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  KEY `id_card` <span class="token punctuation">(</span>`id_card`<span class="token punctuation">)</span><span class="token punctuation">,</span>
  KEY `name_age` <span class="token punctuation">(</span>`name`<span class="token punctuation">,</span>`age`<span class="token punctuation">)</span>
<span class="token punctuation">)</span> ENGINE<span class="token operator">=</span>InnoDB
</code></pre></div><p>我们知道，身份证号是市民的唯一标识。也就是说，如果有根据身份证号查询市民信息的需求，我们只要在身份证号字段上建立索引就够了。而再建立一个（身份证号、姓名）的联合索引，是不是浪费空间？</p> <p>如果现在有一个高频请求，要根据市民的身份证号查询他的姓名，这个联合索引就有意义了。它可以在这个高频请求上用到覆盖索引，不再需要回表查整行记录，减少语句的执行时间。</p> <p>当然，索引字段的维护总是有代价的。因此，在建立冗余索引来支持覆盖索引时就需要权衡考虑了。这正是业务 DBA，或者称为业务数据架构师的工作。</p> <h2 id="最左前缀原则"><a href="#最左前缀原则" class="header-anchor">#</a> 最左前缀原则</h2> <p>看到这里你一定有一个疑问，如果为每一种查询都设计一个索引，索引是不是太多了。如果我现在要按照市民的身份证号去查他的家庭地址呢？虽然这个查询需求在业务中出现的概率不高，但总不能让它走全表扫描吧？反过来说，单独为一个不频繁的请求创建一个（身份证号，地址）的索引又感觉有点浪费。应该怎么做呢？</p> <p>这里，我先和你说结论吧。<strong>B+ 树这种索引结构，可以利用索引的“最左前缀”，来定位记录。</strong></p> <p>为了直观地说明这个概念，我们用（name，age）这个联合索引来分析。</p> <p><img src="/shancaolv-blog/assets/img/89f74c631110cfbc83298ef27dcd6370.b5daa397.jpg" alt="img"></p> <p>图 2 （name，age）索引示意图</p> <p>可以看到，索引项是按照索引定义里面出现的字段顺序排序的。</p> <p>当你的逻辑需求是查到所有名字是“张三”的人时，可以快速定位到 ID4，然后向后遍历得到所有需要的结果。</p> <p>如果你要查的是所有名字第一个字是“张”的人，你的 SQL 语句的条件是&quot;where name like ‘张 %’&quot;。这时，你也能够用上这个索引，查找到第一个符合条件的记录是 ID3，然后向后遍历，直到不满足条件为止。</p> <p>可以看到，不只是索引的全部定义，只要满足最左前缀，就可以利用索引来加速检索。这个最左前缀可以是联合索引的最左 N 个字段，也可以是字符串索引的最左 M 个字符。</p> <p>基于上面对最左前缀索引的说明，我们来讨论一个问题：<strong>在建立联合索引的时候，如何安排索引内的字段顺序。</strong></p> <p>这里我们的评估标准是，索引的复用能力。因为可以支持最左前缀，所以当已经有了 (a,b) 这个联合索引后，一般就不需要单独在 a 上建立索引了。因此，<strong>第一原则是，如果通过调整顺序，可以少维护一个索引，那么这个顺序往往就是需要优先考虑采用的。</strong></p> <p>所以现在你知道了，这段开头的问题里，我们要为高频请求创建 (身份证号，姓名）这个联合索引，并用这个索引支持“根据身份证号查询地址”的需求。</p> <p>那么，如果既有联合查询，又有基于 a、b 各自的查询呢？查询条件里面只有 b 的语句，是无法使用 (a,b) 这个联合索引的，这时候你不得不维护另外一个索引，也就是说你需要同时维护 (a,b)、(b) 这两个索引。</p> <p>这时候，我们要<strong>考虑的原则就是空间</strong>了。比如上面这个市民表的情况，name 字段是比 age 字段大的 ，那我就建议你创建一个（name,age) 的联合索引和一个 (age) 的单字段索引。</p> <h2 id="索引下推"><a href="#索引下推" class="header-anchor">#</a> 索引下推</h2> <p>上一段我们说到满足最左前缀原则的时候，最左前缀可以用于在索引中定位记录。这时，你可能要问，那些不符合最左前缀的部分，会怎么样呢？</p> <p>我们还是以市民表的联合索引（name, age）为例。如果现在有一个需求：检索出表中“名字第一个字是张，而且年龄是 10 岁的所有男孩”。那么，SQL 语句是这么写的：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tuser <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'张 %'</span> <span class="token operator">and</span> age<span class="token operator">=</span><span class="token number">10</span> <span class="token operator">and</span> ismale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><p>你已经知道了前缀索引规则，所以这个语句在搜索索引树的时候，只能用 “张”，找到第一个满足条件的记录 ID3。当然，这还不错，总比全表扫描要好。</p> <p>然后呢？</p> <p>当然是判断其他条件是否满足。</p> <p>在 MySQL 5.6 之前，只能从 ID3 开始一个个回表。到主键索引上找出数据行，再对比字段值。</p> <p>而 MySQL 5.6 引入的索引下推优化（index condition pushdown)， 可以在索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数。</p> <p>图 3 和图 4，是这两个过程的执行流程图。</p> <p><img src="/shancaolv-blog/assets/img/b32aa8b1f75611e0759e52f5915539ac.b32aa8b1.jpg" alt="img"></p> <p>图 3 无索引下推执行流程</p> <p><img src="/shancaolv-blog/assets/img/76e385f3df5a694cc4238c7b65acfe1b.379d5a35.jpg" alt="img"></p> <p>图 4 索引下推执行流程</p> <p>在图 3 和 4 这两个图里面，每一个虚线箭头表示回表一次。</p> <p>图 3 中，在 (name,age) 索引里面我特意去掉了 age 的值，这个过程 InnoDB 并不会去看 age 的值，只是按顺序把“name 第一个字是’张’”的记录一条条取出来回表。因此，需要回表 4 次。</p> <p>图 4 跟图 3 的区别是，InnoDB 在 (name,age) 索引内部就判断了 age 是否等于 10，对于不等于 10 的记录，直接判断并跳过。在我们的这个例子中，只需要对 ID4、ID5 这两条记录回表取数据判断，就只需要回表 2 次。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>今天这篇文章，我和你继续讨论了数据库索引的概念，包括了覆盖索引、前缀索引、索引下推。你可以看到，在满足语句需求的情况下， 尽量少地访问资源是数据库设计的重要原则之一。我们在使用数据库的时候，尤其是在设计表结构时，也要以减少资源消耗作为目标。</p> <p>接下来我给你留下一个问题吧。</p> <p>实际上主键索引也是可以使用多个字段的。DBA 小吕在入职新公司的时候，就发现自己接手维护的库里面，有这么一个表，表结构定义类似这样的：</p> <div class="language-go extra-class"><pre class="language-go"><code>CREATE TABLE <span class="token string">`geek`</span> <span class="token punctuation">(</span>
  <span class="token string">`a`</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> NOT NULL<span class="token punctuation">,</span>
  <span class="token string">`b`</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> NOT NULL<span class="token punctuation">,</span>
  <span class="token string">`c`</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> NOT NULL<span class="token punctuation">,</span>
  <span class="token string">`d`</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> NOT NULL<span class="token punctuation">,</span>
  PRIMARY KEY <span class="token punctuation">(</span><span class="token string">`a`</span><span class="token punctuation">,</span><span class="token string">`b`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  KEY <span class="token string">`c`</span> <span class="token punctuation">(</span><span class="token string">`c`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  KEY <span class="token string">`ca`</span> <span class="token punctuation">(</span><span class="token string">`c`</span><span class="token punctuation">,</span><span class="token string">`a`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  KEY <span class="token string">`cb`</span> <span class="token punctuation">(</span><span class="token string">`c`</span><span class="token punctuation">,</span><span class="token string">`b`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> ENGINE<span class="token operator">=</span>InnoDB<span class="token punctuation">;</span>
</code></pre></div><p>公司的同事告诉他说，由于历史原因，这个表需要 a、b 做联合主键，这个小吕理解了。</p> <p>但是，学过本章内容的小吕又纳闷了，既然主键包含了 a、b 这两个字段，那意味着单独在字段 c 上创建一个索引，就已经包含了三个字段了呀，为什么要创建“ca”“cb”这两个索引？</p> <p>同事告诉他，是因为他们的业务里面有这样的两种语句：</p> <div class="language-vbnet extra-class"><pre class="language-vbnet"><code><span class="token keyword">select</span> <span class="token operator">*</span> from geek where c<span class="token operator">=</span>N order by a limit <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> from geek where c<span class="token operator">=</span>N order by b limit <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><p>我给你的问题是，这位同事的解释对吗，为了这两个查询模式，这两个索引是否都是必须的？为什么呢？</p> <p>你可以把你的思考和观点写在留言区里，我会在下一篇文章的末尾和你讨论这个问题。感谢你的收听，也欢迎你把这篇文章分享给更多的朋友一起阅读。</p> <h2 id="上期问题时间"><a href="#上期问题时间" class="header-anchor">#</a> 上期问题时间</h2> <p>上期的问题是，通过两个 alter 语句重建索引 k，以及通过两个 alter 语句重建主键索引是否合理。</p> <p>在评论区，有同学问到为什么要重建索引。我们文章里面有提到，索引可能因为删除，或者页分裂等原因，导致数据页有空洞，重建索引的过程会创建一个新的索引，把数据按顺序插入，这样页面的利用率最高，也就是索引更紧凑、更省空间。</p> <p>这道题目，我给你的“参考答案”是：</p> <p>重建索引 k 的做法是合理的，可以达到省空间的目的。但是，重建主键的过程不合理。不论是删除主键还是创建主键，都会将整个表重建。所以连着执行这两个语句的话，第一个语句就白做了。这两个语句，你可以用这个语句代替 ： alter table T engine=InnoDB。在专栏的第 12 篇文章《为什么表数据删掉一半，表文件大小不变？》中，我会和你分析这条语句的执行流程。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/shancaolv-blog/theory/mysql4.html" class="prev">
          mysql4 
        </a></span> <span class="next"><a href="/shancaolv-blog/theory/mysql6.html">
          mysql6 
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:0;" data-v-b57cc07c data-v-7dd95ae2></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/shancaolv-blog/assets/js/app.d9fe4499.js" defer></script><script src="/shancaolv-blog/assets/js/3.c1ecc667.js" defer></script><script src="/shancaolv-blog/assets/js/1.6b777cdb.js" defer></script><script src="/shancaolv-blog/assets/js/12.39fb974a.js" defer></script>
  </body>
</html>
